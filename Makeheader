##DEBUG=0 (default) assumes RELEASE mode (maximum optimizations) otherwise DEBUG mode is assumded (with optional
DEBUG=0

##Do we want -pg to be included in compilation time (default)
PROFILE=0

LIBMDDIR?=.

##This is to be used for all modes:
#Compiler
CC=g++
#Comilation message
MSG=$(shell date) by $(shell whoami)'@'$(shell hostname)
VER=0.$(shell git -C '$(LIBMDDIR)' rev-list HEAD --count)
BRANCH=$(shell git -C '$(LIBMDDIR)' rev-parse --abbrev-ref HEAD)
STD=c++11
CCWFLAGS=-Wall -Wextra
THREAD=NOTHREADS
CCDFLAGS=-D CMSG='"$(MSG)"'
CCDFLAGS+= -D $(THREAD)
CCDFLAGS+= -D VER='"$(VER)"'
CCDFLAGS+= -D BRANCH='"$(BRANCH)"'

ifeq ($(DEBUG),0)
##This is to be used in RELEASE mode
	PASS_ERROR=1 ##Pass libmd errors
	PASS_WARNING=0 ##Pass libmd warnings
	DEBUG_LEVEL=0 ##libmd debug level
	EXCEPTIONS=0 ##Throw libmd exceptions 
	DEBUGFLAG=0 ##If we want -g as a compile option
	CCOPTLEVEL=3 ##Optimizations level
	LTO=1 ##Link time optizmizations
    MARCH=1 ##Optimize for native cpu
    STATIC=0 ##Create a static build
    STRIP=0 ##Strip useless symbols
else
##This is to be used in DEBUG mode
	PASS_ERROR=1
	PASS_WARNING=1
	DEBUG_LEVEL=0
	EXCEPTIONS=0
	CCOPTLEVEL=0
	DEBUGFLAG=1
	LTO=0
    MARCH=0
    STATIC=0
    STRIP=0
endif

##This defines the thread model
ifeq ($(THREAD),OPENMP)
	CCTHREADFLAG=-fopenmp
else ifeq ($(THREAD),THREADS)
	CCTHREADFLAG=-pthread
else
	CCTHREADFLAG=
endif


##This part injects definitions into the code
ifeq ($(PASS_ERROR),1)
	CCDFLAGS+= -D PASS_ERROR
endif
ifeq ($(PASS_WARNING),1)
	CCDFLAGS+= -D PASS_WARNING
endif
ifneq ($(DEBUG_LEVEL),0)
	CCDFLAGS+= -D DEBUG_LEVEL=$(DEBUG_LEVEL)
endif
ifneq ($(DEBUG_LEVEL),0)
	CCDFLAGS+= -D EXCEPTIONS=$(EXCEPTIONS)
endif

##Concatenate everything together
CCFLAGS=$(CCWFLAGS)
CCFLAGS+= -std=$(STD)
ifeq ($(DEBUGFLAG),1)
	CCFLAGS+= -g
endif
ifneq ($(PROFILE),0)
	CCFLAGS+= -pg
endif
ifneq ($(LTO),0)
	CCFLAGS+= -flto
endif
ifneq ($(MARCH),0)
	CCFLAGS+= -march=native
endif
ifneq ($(STATIC),0)
	CCFLAGS+= -static
endif
ifneq ($(STRIP),0)
	CCFLAGS+= -s
endif
CCFLAGS+= -O$(CCOPTLEVEL)
CCFLAGS+= $(CCTHREADFLAG)
CCFLAGS+= $(CCDFLAGS)

##And finaly tell the code about yourself
CCDDFLAGS:=$(CCFLAGS)
CCFLAGS+= -D CC='"$(CC) $(CCDDFLAGS)"'

##Make patterns
%.o: %.cc
	$(CC) $(CCFLAGS) -c $<
 
%: %.cc
	$(CC) $(CCFLAGS) -o $@ $<
